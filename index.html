<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>日文單字測驗（PWA）</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">
  <style>
  :root { --bg:#0ea5e9; --fg:#0b1324; --muted:#6b7280; --card:#ffffff; --bd:#e5e7eb; --ok:#22c55e; --bad:#ef4444; }
  * { box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial; margin: 0 auto; max-width: 880px; padding: 16px; background:#f8fafc; color:var(--fg); }
  header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  h1 { font-size: 20px; margin: 8px 0; }
  .muted { color: var(--muted); font-size: 12px; }
  .card { border:1px solid var(--bd); border-radius:14px; padding:16px; background:var(--card); box-shadow:0 2px 8px rgba(0,0,0,.05); margin-top:12px;}
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center }
  input[type="number"] { width: 90px; padding:8px 10px; border-radius:10px; border:1px solid var(--bd); }
  input[type="file"] { padding:6px 0; }
  button { padding:10px 14px; border-radius:10px; border:1px solid var(--bd); background:#fff; cursor:pointer }
  button.primary { background:var(--bg); color:#fff; border-color:var(--bg) }
  button.danger { background:#fff0f0; color:#b91c1c; border-color:#fecaca }
  button:disabled { opacity:.55; cursor:not-allowed }

  /* ==== 新增：選項改成自適應格子佈局 ==== */
  #opts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
  }

  button.opt {
    padding: 20px;
    font-size: 18px;
    text-align: center;
    border: 2px solid var(--bd);
    border-radius: 16px;
    background: #fff;
    cursor: pointer;
    width: 100%;
    height: 100px; /* 可以依需求調整 */
  }

  /* 固定在底部的「下一題」按鈕 不然手機板用起來不舒服*/
  #next-btn-fixed {
    position: fixed;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    width: calc(100% - 40px);
    max-width: 400px;
    padding: 20px;
    font-size: 18px;
    border: 2px solid var(--bd);
    border-radius: 16px;
    background: #fff;
  }

  .opt.correct {
    border-color: var(--ok);
    background: #ecfdf5;
    color: #000;           /* 黑色字 */
    font-weight: bold;     /* 粗體 */
  }
  .opt.wrong { border-color:var(--bad); background:#fef2f2; }

  .seg { display:inline-flex; border:1px solid var(--bd); border-radius:12px; overflow:hidden }
  .seg button { border:0; padding:8px 12px; }
  .seg button.active { background:#eef6ff; border-color:#bfdbfe }
  table { width:100%; border-collapse: collapse; }
  th, td { padding:8px 10px; border-bottom:1px solid var(--bd); text-align:left; font-size:14px }
  th { background:#f3f4f6; }
  .hidden { display:none !important; }
  .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--bd); background:#fff }
  .right { text-align:right }

  /* hover 效果 */
  @media (hover:hover) { 
    button.opt:hover { transform: scale(1.05); transition: transform 0.15s; }
  }
</style>

</head>
<body>
  <header>
    <div>
      <h1>日文單字測驗（PWA）</h1>
    </div>
    <div class="seg" role="tablist" aria-label="視圖切換">
      <button id="tab-quiz" class="active" aria-selected="true">測驗</button>
      <button id="tab-stats" aria-selected="false">成績</button>
    </div>
  </header>

  <section class="card" id="controls">
    <div class="row" style="align-items:flex-end">
      <div>
        <div class="muted">上傳題庫</div>
        <input type="file" id="file" accept=".xlsx,.xls" />
      </div>
      <div>
        <div class="muted">題數</div>
        <input type="number" id="numQ" min="1" max="200" value="10">
      </div>
      <div>
        <div class="muted">題型</div>
        <div class="seg">
          <button id="mode-both" class="active" title="讀音 + 中→日">讀音+日→中</button>
          <button id="mode-zh2jp" title="只中→日">只日→中</button>
          <button id="mode-pron" title="只讀音">只讀音</button>
        </div>
      </div>
      <div>
        <div class="muted">考試等級</div>
        <div class="row" style="gap:8px">
          <label><input type="checkbox" id="levelN5" value="N5"> N5</label>
          <label><input type="checkbox" id="levelN4" value="N4"> N4</label>
          <label><input type="checkbox" id="levelN3" value="N3"> N3</label>
        </div>
      </div>
      <div>
      <div class="muted">詞性分級</div>
        <div class="row" style="gap:8px">
          <label><input type="checkbox" id="posN" value="N"> N</label>
          <label><input type="checkbox" id="posV" value="V"> V</label>
          <label><input type="checkbox" id="posAdjAdv" value="Adj_Adv"> Adj/Adv</label>
          <label><input type="checkbox" id="posKana" value="片仮名"> 片仮名</label>
          <label><input type="checkbox" id="posGreeting" value="挨拶語"> 挨拶語</label>
        </div>
      </div>

      <div class="row">
        <button id="btnStart" class="primary" disabled>開始測驗</button>
        <button id="btnReset" class="danger">清除本機成績</button>
        <button id="btnExportXLSX">下載更新後的 XLSX</button>
        <button id="btnExportCSV">下載成績 CSV</button>
      </div>
    </div>
  </section>

  <section id="quiz" class="card">
    <div id="qmeta" class="muted" style="margin-bottom:8px">
      <span id="qtype" class="pill">題型</span>
      <span id="progress" class="pill">進度</span>
    </div>
    <div id="qstem" style="font-size:20px; font-weight:700; margin-bottom:8px">請先載入題庫</div>
    <div id="opts"></div>
  </section>

  <section id="stats" class="card hidden" aria-live="polite">
    <h2 style="margin:0 0 8px 0; font-size:18px">成績檢視</h2>
    <div class="muted" style="margin-bottom:8px">依「正確率」由低到高排序；可用來找出易錯單字。</div>
    <div id="stats-summary" class="row" style="gap:8px; margin-bottom:8px"></div>
    <div style="overflow:auto">
      <table id="stats-table">
        <thead>
          <tr>
            <th>中文解釋</th><th>日文/讀音</th><th class="right">作答</th>
            <th class="right">正確</th><th class="right">錯誤</th><th class="right">正確率%</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- 讀/寫 xlsx 的外掛（CDN） -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // ====== 全域狀態 ======
    let allRows = [];                   // 所有題目
    let rows = [];                      // 過濾題庫(拿來出題)
    let selectedLevels = [];            // 題目Level
    let selectedPOS = [];               // 題目詞性
    let asked = 0, total = Number(document.getElementById('numQ').value) || 10; //目標題數

    let mode = "both";                  // 題型模式
    const ALPHA = 0.8, BETA = 0.6;      // 權重
    const KEY_STATS = "jp_quiz_stats_v1";

    let sessionWrongs = []; // 本回合錯題清單

    function loadStats(){ try{ return JSON.parse(localStorage.getItem(KEY_STATS)||"{}"); }catch{return {}} }
    function saveStats(obj){ localStorage.setItem(KEY_STATS, JSON.stringify(obj)); }
    function resetStats(){ localStorage.removeItem(KEY_STATS); }

    // ====== UI 元件 ======
    const btnStart = document.getElementById('btnStart');
    const btnReset = document.getElementById('btnReset');
    const btnExportXLSX = document.getElementById('btnExportXLSX');
    const btnExportCSV = document.getElementById('btnExportCSV');
    const iptNum = document.getElementById('numQ');
    const qBox = document.getElementById('quiz'), stem = document.getElementById('qstem'),
          qtype= document.getElementById('qtype'), opts = document.getElementById('opts'),
          prog = document.getElementById('progress');
    const tabQuiz = document.getElementById('tab-quiz');
    const tabStats= document.getElementById('tab-stats');
    const modeBoth= document.getElementById('mode-both');
    const modeZh2jp=document.getElementById('mode-zh2jp');
    const modePron=document.getElementById('mode-pron');

    // ====== 事件 ======
    document.getElementById('file').addEventListener('change', async (e) => {
      const f = e.target.files[0]; if (!f) return;
      const buf = await f.arrayBuffer();
      const wb = XLSX.read(buf);
      const ws = wb.Sheets[wb.SheetNames[0]];
      rows = XLSX.utils.sheet_to_json(ws, {defval:""});
      allRows = rows;  // 存一份完整的
      normalizeRows();
      asked = 0;
      btnStart.disabled = rows.length === 0;
      renderStats();
      alert(`已載入 ${rows.length} 筆。`);
    });

    iptNum.oninput = () => { const v = Math.max(1, Math.min(200, Number(iptNum.value)||10)); total = v; iptNum.value = v; };

    function getSelectedLevels(){
      const levels = [];
      if (document.getElementById("levelN5").checked) levels.push("N5");
      if (document.getElementById("levelN4").checked) levels.push("N4");
      if (document.getElementById("levelN3").checked) levels.push("N3");
      return levels;
    }

    function getSelectedPOS(){
      const pos = [];
      if (document.getElementById("posN").checked) pos.push("N");
      if (document.getElementById("posV").checked) pos.push("V");
      if (document.getElementById("posAdjAdv").checked) pos.push("Adj_Adv");
      if (document.getElementById("posKana").checked) pos.push("片仮名");
      if (document.getElementById("posGreeting").checked) pos.push("挨拶語");
      return pos;
    }


    btnStart.onclick = () => {
      total = Number(document.getElementById('numQ').value) || 10;
      asked = 0;
      selectedLevels = getSelectedLevels();
      selectedPOS = getSelectedPOS();

      // 如果等級與詞性都沒選，預設為「全部都可以考」
      if (selectedLevels.length === 0 && selectedPOS.length === 0){
        alert("未選擇等級或詞性，將預設全部題目。");
      }
      normalizeRows();   // 重新依照等級過濾
      asked=0;
      sessionWrongs = [];          // 重置
      nextQuestion();
      switchTab('quiz');
    };

    btnReset.onclick = () => { resetStats(); renderStats(); alert("已清除本機成績。"); };
    btnExportCSV.onclick = exportCSV;
    btnExportXLSX.onclick = exportXLSX;

    modeBoth.onclick = () => setMode('both');
    modeZh2jp.onclick = () => setMode('zh2jp');
    modePron.onclick = () => setMode('pron');

    tabQuiz.onclick = () => switchTab('quiz');
    tabStats.onclick = () => { renderStats(); switchTab('stats'); };

    function setMode(m){
      mode = m;
      [modeBoth, modeZh2jp, modePron].forEach(b=>b.classList.remove('active'));
      (m==='both'?modeBoth:(m==='zh2jp'?modeZh2jp:modePron)).classList.add('active');
    }
    function switchTab(t){
      if (t==='quiz'){ tabQuiz.classList.add('active'); tabStats.classList.remove('active');
        document.getElementById('stats').classList.add('hidden'); qBox.classList.remove('hidden');
      } else {
        tabStats.classList.add('active'); tabQuiz.classList.remove('active');
        qBox.classList.add('hidden'); document.getElementById('stats').classList.remove('hidden');
      }
    }

    // ====== 資料處理 ======
    function normalizeRows(){
      rows = allRows.map(r=>{
        const word = String(r["單字"]||"").trim();
        const pron = String(r["讀音"]||"").trim();
        const zh   = String(r["中文解釋"]||"").trim();
        const ansC = Number(r["作答次數"]||0)|0;
        const corC = Number(r["正確次數"]||0)|0;
        const acc  = Number(r["正確率"]||0);
        const level = String(r["Level"] || r["LEVEL"] || "").trim(); //過濾level
        const pos  = String(r["詞性"]||"").trim();  
        const surface = word.length?word:pron;

        return { 
          單字: word, 
          讀音: pron, 
          中文解釋: zh, 
          作答次數: ansC, 
          正確次數: corC, 
          正確率: acc, 
          surface, 
          詞性: pos, 
          Level: level 
        };
      }).filter(r => r.surface && r["中文解釋"]);

      // 若使用者有選擇等級，才過濾
      if (selectedLevels.length > 0){
        rows = rows.filter(r => selectedLevels.includes(r.Level));
      }

      // 過濾 詞性
      if (selectedPOS.length > 0){
        rows = rows.filter(r => {
          return selectedPOS.some(sel => {
            const pos = r["詞性"];
            if (sel === "N") {
              // N 開頭但不是 Na-adj
              return pos.startsWith("N") && !pos.startsWith("Na");
            } else if (sel === "Adj_Adv") {
              // Adj、Adv、Na-adj 都算在一起
              return pos === "Adj" || pos === "Adv" || pos === "Na-adj";
            } else {
              // 其他精確比對
              return pos === sel;
            }
          });
        });
      }
      console.log("rows 原始數量", allRows.length);
      console.log("選到的等級", selectedLevels);
      console.log("選到的詞性", selectedPOS);
      console.log("過濾後數量", rows.length);

    }

    function hasKanji(s){ return /[\u4E00-\u9FFF]/.test(s||""); }

    function weights(cands){
      const s = loadStats();
      const w = cands.map(r=>{
        const key = statKey(r);
        const inS = s[key];
        const ans = (inS?.作答次數 ?? r.作答次數) + 1;
        const acc = (inS?.正確率 ?? r.正確率)/100;
        return Math.pow(ans, -0.8) * Math.pow(1-acc, 0.6);
      });
      const sum = w.reduce((a,b)=>a+b,0)||1;
      return w.map(x=>x/sum);
    }

    function pick(cands){
      const ws = weights(cands);
      let r = Math.random(), cum=0;
      for (let i=0;i<cands.length;i++){ cum+=ws[i]; if (r<=cum) return cands[i]; }
      return cands[cands.length-1];
    }

    function statKey(r){ return `${r["中文解釋"]}__${r["單字"]}__${r["讀音"]}`; }

    // ====== 出題流程 ======
    function nextQuestion(){
      if (!rows.length){ stem.textContent = "請先載入題庫"; return; }
      if (asked >= total){
        stem.textContent = sessionWrongs.length
          ? "測驗結束。以下是本回合的錯題回顧："
          : "測驗結束。本回合全對！";
        opts.innerHTML = sessionWrongs.map(r =>
          `<div style="margin:6px 0; padding:6px; border:1px solid #eee; border-radius:8px">
            <b>${escapeHtml(r.中文解釋)}</b> → ${escapeHtml(r.單字 || "")}${r.讀音 ? `（${escapeHtml(r.讀音)}）` : ""}
          </div>`
        ).join("");
        return;
      }


      const cands = rows.filter(r=> r.surface && r["中文解釋"]);
      if (!cands.length){ stem.textContent = "題庫為空"; opts.innerHTML=""; return; }

      let rec = pick(cands), retry=0;
      const s = loadStats();
      while (((s[statKey(rec)]?.正確率 ?? rec.正確率) >= 90) && retry<8){
        rec = pick(cands); retry++;
      }

      // 題型決定
      let types = [];
      if (mode==='both' || mode==='pron'){
        if (hasKanji(rec["單字"]) && rec["讀音"]) types.push('讀音');
      }
      if (mode==='both' || mode==='zh2jp') types.push('日文->中文');

      asked++;
      presentCard(rec, types);
    }

    function choiceOptions(pool, correct, pos, k=4, level){
      // 選項必須同詞性 & 同 Level
      const samePOS = pool.filter(x => x.詞性 === pos && x.Level === level).map(x => x.value);
      const uniq = [...new Set(samePOS.filter(x => x && x !== correct))];
      const n = Math.min(k, uniq.length);
      const wrongs = [];
      while (wrongs.length < n){
        const x = uniq[Math.floor(Math.random() * uniq.length)];
        if (!wrongs.includes(x)) wrongs.push(x);
      }
      return [...wrongs, correct].sort(() => Math.random() - 0.5);
    }


    function choiceOptions(pool, correct, pos, k=4, level){
  // 選項必須同詞性 & 同 Level
  const samePOS = pool.filter(x => x.詞性 === pos && x.Level === level).map(x => x.value);
  const uniq = [...new Set(samePOS.filter(x => x && x !== correct))];
  const n = Math.min(k, uniq.length);
  const wrongs = [];
  while (wrongs.length < n){
    const x = uniq[Math.floor(Math.random() * uniq.length)];
    if (!wrongs.includes(x)) wrongs.push(x);
  }
  return [...wrongs, correct].sort(() => Math.random() - 0.5);
}

    function presentCard(rec, types){
      let allCorrect = true;   // 本題是否全對

      const doOne = (qi) => {
        if (qi >= types.length){
          const s = loadStats();
          const key = statKey(rec);
          const ans = (s[key]?.作答次數 ?? rec.作答次數) + 1;
          const cor = (s[key]?.正確次數 ?? rec.正確次數) + (allCorrect ? 1 : 0);
          s[key] = { 作答次數: ans, 正確次數: cor, 正確率: ans ? (cor/ans*100) : 0 };
          saveStats(s);

          if (!allCorrect){
            sessionWrongs.push({
              中文解釋: rec["中文解釋"],
              單字: rec["單字"],
              讀音: rec["讀音"]
            });
          }

          setTimeout(nextQuestion, 650);
          return;
        }

        // ==== 準備本小題 ====
        const t = types[qi];
        let correct, pool, prompt;

        if (t === '讀音'){
          correct = String(rec["讀音"]);
          pool = rows.map(x => ({
            value: String(x["讀音"]),
            詞性: x["詞性"],
            Level: x["Level"]
          }));
          prompt = `請選出「${rec["單字"]}」的正確讀音：`;
        } else {
          correct = String(rec["中文解釋"]);
          pool = rows.map(x => ({
            value: String(x["中文解釋"]),
            詞性: x["詞性"],
            Level: x["Level"]
          }));
          prompt = `請選出「${rec["surface"]}」的正確中文解釋：`;
        }

        qtype.textContent = `題型：${t}`;
        prog.textContent  = `進度：第 ${asked}/${total} 題`;
        stem.textContent  = prompt;
        opts.innerHTML    = "";

        // 取得選項（同詞性 & 同 Level）
        const options = choiceOptions(pool, correct, rec["詞性"], 4, rec["Level"]);

        options.forEach(opt => {
          const btn = document.createElement('button');
          btn.className = 'opt';
          btn.textContent = opt;

          btn.onclick = () => {
            const ok = String(opt) === String(correct);
            btn.classList.add(ok ? 'correct' : 'wrong');
            Array.from(opts.children).forEach(b => b.disabled = true);

            if (!ok){
              allCorrect = false;
              // 直接把正確選項加上 .correct 樣式
              Array.from(opts.children).forEach(b => {
                if (b.textContent === String(correct)) {
                  b.classList.add('correct');
                }
              });

              // 顯示「下一題」按鈕（固定在底部）
              const nextBtn = document.createElement('button');
              nextBtn.id = 'next-btn-fixed';
              nextBtn.textContent = '下一題';
              nextBtn.onclick = () => { nextBtn.disabled = true; doOne(qi + 1); nextBtn.remove(); };
              document.body.appendChild(nextBtn);
            } else {
              setTimeout(() => doOne(qi + 1), 650);
            }
          };

          opts.appendChild(btn);
        });
      };

      doOne(0);
    }

    // ====== 成績檢視 / 匯出 ======
    function mergedStatsRows(){
      const s = loadStats();
      return rows.map(r=>{
        const key = statKey(r);
        const ans = s[key]?.作答次數 ?? r.作答次數;
        const cor = s[key]?.正確次數 ?? r.正確次數;
        const acc = s[key]?.正確率 ?? r.正確率;
        const wrong = Math.max(0, ans - cor);
        return { ...r, 作答次數: ans, 正確次數: cor, 錯誤次數: wrong, 正確率: acc };
      });
    }

    function renderStats(){
      const data = mergedStatsRows().sort((a,b)=> (a.正確率 - b.正確率) || (b.作答次數 - a.作答次數));
      const tb = document.querySelector('#stats-table tbody');
      tb.innerHTML = "";
      for (const r of data){
        const tr = document.createElement('tr');
        tr.innerHTML = [
          `<td>${escapeHtml(r["中文解釋"])}</td>`,
          `<td>${escapeHtml(r["surface"]||r["讀音"])}</td>`,
          `<td class="right">${r["作答次數"]}</td>`,
          `<td class="right">${r["正確次數"]}</td>`,
          `<td class="right">${r["錯誤次數"]}</td>`,
          `<td class="right">${(Number(r["正確率"])||0).toFixed(2)}</td>`
        ].join("");
        tb.appendChild(tr);
      }

      const totalAns = data.reduce((s,r)=>s + (Number(r["作答次數"])||0), 0);
      const totalCor = data.reduce((s,r)=>s + (Number(r["正確次數"])||0), 0);
      const totalAcc = totalAns? (totalCor/totalAns*100):0;
      document.getElementById('stats-summary').innerHTML = `
        <span class="pill">總作答：${totalAns}</span>
        <span class="pill">總正確：${totalCor}</span>
        <span class="pill">總正確率：${totalAcc.toFixed(2)}%</span>
        <span class="pill">單字數：${rows.length}</span>`;
    }

    function exportCSV(){
      const arr = [["中文解釋","單字","讀音","作答次數","正確次數","錯誤次數","正確率"]];
      for (const r of mergedStatsRows()){
        arr.push([r["中文解釋"], r["單字"], r["讀音"], r["作答次數"], r["正確次數"], r["錯誤次數"], Number(r["正確率"]||0).toFixed(2)]);
      }
      const csv = arr.map(row=> row.map(String).map(x=> x.includes(",")||x.includes('"') ? `"${x.replace(/"/g,'""')}"` : x).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "quiz_stats.csv";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function exportXLSX(){
      const data = mergedStatsRows().map(r=>{
        const { surface, ...rest } = r; // 不輸出 surface 欄
        return rest;
      });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "Sheet1");
      XLSX.writeFile(wb, "Vocabulary_updated.xlsx");
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // PWA
    if ('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js');
    }
  </script>
</body>
</html>
